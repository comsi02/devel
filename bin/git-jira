#!/c/Python27/python
# -*- coding:utf-8 -*-
import subprocess
import json
import sys
import pycurl
from StringIO import StringIO

JIRA_URL = 'http://jira.daumkakao.com/rest/api/2/issue/'
JIRA_AUTH = 'YW5kcmV3LnNvbmc6d2pzcmhrZHVzMDIh'

class bcolors:
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'
    RED = '\033[31m'
    GREEN = '\033[32m'
    YELLOW = '\033[33m'
    BLUE = '\033[34m'
    PURPLE = '\033[35m'
    SKYBLUE = '\033[36m'
    GREY = '\033[37m'
    WHITE = '\033[38m'

    COLOR_HASH = {
        'endc':ENDC,
        'underline':UNDERLINE,
        'bold':BOLD,
        'red':RED,
        'green':GREEN,
        'yellow':YELLOW,
        'blue':BLUE,
        'purple':PURPLE,
        'skyblue':SKYBLUE,
        'grey':GREY,
        'white':WHITE,
        'orange':SKYBLUE,
        'fail':RED,
        'warning':YELLOW,
        'normal':WHITE,
    }

    @staticmethod
    def set_ansi_color(string, color=None):
        return bcolors.COLOR_HASH.get(color,bcolors.WHITE) + string + bcolors.ENDC

def get_jira_issue(branch_name):

    buffer = StringIO()
    c = pycurl.Curl()
    c.setopt(c.URL, "{0}{1}".format(JIRA_URL,branch_name))
    c.setopt(c.HTTPHEADER, ["Authorization:Basic {0}".format(JIRA_AUTH)])
    c.setopt(c.WRITEDATA, buffer)
    c.perform()
    c.close()
    body = buffer.getvalue()

    issue_dict = json.loads(body)
    fields = issue_dict.get('fields') or ''

    if (fields):
        issue_name = fields.get('summary').encode('utf-8')
        issue_status = bcolors.set_ansi_color("[{0}]".format(fields.get('status').get('name').encode('utf-8')),'skyblue')
        return "{0} {1}".format(issue_status,issue_name)

    return ''

def main():

    branch_opt = ""

    if "-a" in sys.argv:
        branch_opt = "--all"

    pr = subprocess.Popen("git branch -v {0}".format(branch_opt),
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        shell=True)

    (out, error) = pr.communicate()

    branches = out.rstrip().split('\n')

    for b in branches:
        is_current_branch = b[:2].strip()
        branch_infos = b[2:].split()
        branch_name = branch_infos[0]
        branch_head = branch_infos[1]
        branch_comment = ' '.join(branch_infos[2:])
        issue_name = get_jira_issue(branch_name)

        if is_current_branch == '*':
            branch_name = bcolors.set_ansi_color(branch_name,'green')
        else:
            branch_name = bcolors.set_ansi_color(branch_name,'red')

        branch_head = bcolors.set_ansi_color(branch_head,'yellow')

        print "%2s %-24s %-18s %s" % (
            is_current_branch,
            branch_name,
            branch_head,
            issue_name or branch_comment
        )

if __name__ == '__main__':
    main()
